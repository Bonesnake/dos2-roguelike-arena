Version 1
SubGoalCombiner SGC_AND
INITSECTION

KBSECTION
IF
CharacterEnteredTrigger(_Character, _Trigger)
AND
DB_RoguelikeArena_ArenaEventTriggers(_, _Trigger)
THEN
SetInArena(_Character, 1);

IF
CharacterLeftTrigger(_Character, _Trigger)
AND
CharacterIsDead(_Character, 0)
AND
CharacterIsPolymorphInteractionDisabled(_Character, 0)
AND
DB_RoguelikeArena_ArenaEventTriggers(_Arena, _Trigger)
THEN
SetInArena(_Character, 0);

IF
CharacterDied(_Character)
AND
GetFaction(_Character, "Evil NPC")
AND
DB_RoguelikeArena_ActiveArena(_Arena, _Level, _Difficulty, _Players)
AND
QRY_RoguelikeArena_ObjectIsInArena(_Character, _Arena)
AND
NOT QRY_RoguelikeArena_AnyArenaEnemiesAlive(_Arena)
AND
QRY_RoguelikeArena_AnyoneInCombat(_Arena)
THEN
PROC_RoguelikeArena_ArenaCombatEnded(_Arena, _Level, _Difficulty, _Players);

PROC
PROC_RoguelikeArena_ArenaCombatEnded((INTEGER)_Arena, (INTEGER)_, (INTEGER)_, (INTEGER)_)
AND
DB_RoguelikeArena_ArenaEventTriggers(_Arena, _Trigger)
AND
DB_InRegion(_Character, _Trigger)
THEN
SetInArena(_Character, 0);
LeaveCombat(_Character);
PROC_RoguelikeArena_CharacterFullRestore(_Character);

PROC
PROC_RoguelikeArena_ArenaCombatEnded(_Arena, _, _, _)
AND
DB_RoguelikeArena_ArenaEventTriggers(_Arena, _Trigger)
AND
DB_InRegion(_Character, _Trigger)
AND
IsTagged(_Character, "AI_IGNORED_TARGET", 1)
THEN
SetOnStage(_Character, 0);

QRY
QRY_RoguelikeArena_AnyArenaEnemiesAlive((INTEGER)_Arena)
AND
DB_RoguelikeArena_ArenaEventTriggers(_Arena, _Trigger)
AND
DB_InRegion(_Character, _Trigger)
AND
GetFaction(_Character, "Evil NPC")
AND
CharacterIsDead(_Character, 0)
THEN
DB_NOOP(1);

QRY
QRY_RoguelikeArena_AnyoneInCombat((INTEGER)_Arena)
AND
DB_InRegion(_Character, _Trigger)
AND
CharacterIsInCombat(_Character, 1)
THEN
DB_NOOP(1);
EXITSECTION

ENDEXITSECTION
ParentTargetEdge "RoguelikeArena_Arena"
